<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Doing Stuff</title>
  <script>
    var settings = {
      list_events_url: "{% url 'events' %}"
    }
  </script>
  <style>
    body {
      font-family: monospace;
      color: white;
      text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
      font-size: 8em;
      padding:0 1em;
    }
  </style>
</head>
<body>
  {% csrf_token %}
  <div id="messages">

  </div>
  <script>
    var messageDiv = document.getElementById("messages");

    function getEvents(query, callback){
      var xhr = new XMLHttpRequest();
      xhr.open('GET', settings.list_events_url+'?'+query);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader("X-CSRFToken", getCSRFToken());
      xhr.onload = function() {
        if (xhr.status === 200) {
          var response = JSON.parse(xhr.responseText);
          callback(response.results);
        }
      };
      xhr.send();
      /*JSON.stringify({
          name: 'John Smith',
          age: 34
      }));*/
    }

    function getCSRFToken(){
      return document.querySelector("[name=csrfmiddlewaretoken]").value;
    }

    function getUpdates(){
      // update color
      getEvents('event_type=color&limit=1', function(events){
        if(events.length > 0){
          document.body.style.backgroundColor = events[0].data.color;
        }
      });

      // update messages
      getEvents('event_type=message&limit=20', function(events){
        messages.innerHTML = "";
        events.forEach(function(event){  // create a new div element
          var message = document.createElement("div");
          message.className = "message";
          message.innerText = event.data.message;
          messages.appendChild(message);
        });
      });
    }

    setInterval(getUpdates, 100);
  </script>
</body>
</html>